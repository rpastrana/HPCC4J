name: Build KB (Curated + Enhanced Chunking + Index)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: kb-${{ github.ref }}
  cancel-in-progress: true

env:
  # Jira defaults
  JIRA_BASE_URL: https://hpccsystems.atlassian.net
  JIRA_JQL: 'project = JAPI ORDER BY updated DESC'
  JIRA_PAGE_SIZE: '100'
  # Safety guard to avoid endless pagination
  JIRA_MAX_PAGES: '50'
  # Used for provenance URLs in enhanced chunks
  KB_SOURCE_BASE_URL: https://github.com/rpastrana/HPCC4J/blob/master

jobs:
  build-kb:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository (full history for changelog)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Temurin JDK 17 (with Maven cache)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # Javadocs generation disabled
      - name: Generate aggregated Javadocs (disabled)
        if: ${{ false }}
        run: |
          set -euo pipefail
          mvn -B -T1C \
            -DskipTests \
            -Dmaven.test.skip=true \
            -Dmaven.javadoc.failOnError=false \
            -DadditionalJOptions="-J-Xdoclint:none" \
            -DoutputDirectory=target/site/apidocs \
            javadoc:aggregate

      - name: Checkout upstream repo (hpcc-systems/hpcc4j)
        uses: actions/checkout@v4
        with:
          repository: hpcc-systems/hpcc4j
          ref: master
          path: upstream

      - name: Checkout upstream Wiki (hpcc-systems/hpcc4j.wiki)
        uses: actions/checkout@v4
        with:
          repository: hpcc-systems/hpcc4j.wiki
          ref: master
          path: upstream-wiki

      - name: Copy Javadocs → api-reference (only if present)
        run: |
          set -euo pipefail
          if [ -d target/site/apidocs ]; then
            mkdir -p 'kb/topics/api-reference'
            cp -a target/site/apidocs/. 'kb/topics/api-reference/'
          fi

      - name: Copy Wiki markdown → howto
        run: |
          set -euo pipefail
          if [ -d upstream-wiki ]; then
            shopt -s globstar nullglob
            for f in upstream-wiki/**/*.md; do
              rel="${f#upstream-wiki/}"
              dest="kb/topics/howto/${rel}"
              mkdir -p "$(dirname "$dest")"
              cp "$f" "$dest"
            done
          fi

      - name: Copy project docs → project-docs
        run: |
          set -euo pipefail
          mkdir -p 'kb/topics/project-docs'
          for f in upstream/README.md upstream/MIGRATION-*.md upstream/CodeArchitectureAnalysis.md; do
            [ -f "$f" ] || continue
            cp "$f" "kb/topics/project-docs/$(basename "$f")"
          done

      - name: Copy Spark connector example → connectors-spark-hpcc
        run: |
          set -euo pipefail
          if [ -f upstream/spark-hpcc/Examples/PySparkExample.ipynb ]; then
            mkdir -p 'kb/topics/connectors-spark-hpcc'
            cp upstream/spark-hpcc/Examples/PySparkExample.ipynb \
               'kb/topics/connectors-spark-hpcc/PySparkExample.ipynb'
          fi

      - name: Copy wsclient tests → tests-wsclient
        run: |
          set -euo pipefail
          if [ -d upstream/wsclient/src/test/java/org/hpccsystems/ws/client ]; then
            mkdir -p "kb/topics/tests-wsclient/"
            cp -a upstream/wsclient/src/test/java/org/hpccsystems/ws/client \
                  "kb/topics/tests-wsclient/"
          fi

      - name: Copy dfsclient tests → tests-dfsclient (if present)
        run: |
          set -euo pipefail
          if [ -d upstream/dfsclient/src/test/java ]; then
            mkdir -p "kb/topics/tests-dfsclient/"
            cp -a upstream/dfsclient/src/test/java \
                  "kb/topics/tests-dfsclient/"
          fi

      - name: Create CHANGELOG
        run: |
          set -euo pipefail
          mkdir -p 'kb/topics/changelog'
          git log --date=short --pretty=format:'* %h %ad %s (%an)' -n 500 > 'kb/topics/changelog/CHANGELOG.md'

      - name: Maven dependency tree
        run: |
          set -euo pipefail
          mkdir -p 'kb/topics/dependencies'
          mvn -B -q -DskipTests -Dmaven.test.skip=true dependency:tree \
            -DoutputFile='kb/topics/dependencies/dependency-tree.txt' || true

      # ---------- Jira sync via existing Python script (replaces inline curl/jq) ----------
      - name: Setup Python (for Jira fetch)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Jira script dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests python-slugify

      - name: Fetch Jira issues into KB (scripted)
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p 'kb/topics/issues-roadmap'
          if [ -z "${JIRA_EMAIL:-}" ] || [ -z "${JIRA_API_TOKEN:-}" ]; then
            echo "Jira secrets not configured; skipping Jira sync."
            exit 0
          fi

          python .github/scripts/jira_to_kb.py \
            --base "${JIRA_BASE_URL}" \
            --auth "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            --jql "${JIRA_JQL}" \
            --limit "${JIRA_PAGE_SIZE}" \
            --out 'kb/topics/issues-roadmap'

      - name: Upload KB topics (raw)
        uses: actions/upload-artifact@v4
        with:
          name: kb-topics-raw
          path: kb/topics/**/*
          retention-days: 14

      - name: Upload KB staging artifact (curated)
        uses: actions/upload-artifact@v4
        with:
          name: kb-input
          path: |
            kb/topics/**/*
          retention-days: 14

  build_index:
    needs: build-kb
    runs-on: ubuntu-latest
    env:
      PROJECT_CONFIG: '{}'
      ANONYMIZED_TELEMETRY: 'false'
      CHROMA_TELEMETRY_IMPLEMENTATION: 'none'
      CHROMA_ANONYMIZED_TELEMETRY: 'false'
    steps:
      - name: Setup Python early
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Checkout (scripts & constraints)
        uses: actions/checkout@v4

      - name: Download curated KB artifact
        uses: actions/download-artifact@v4
        with:
          name: kb-input
          path: kb

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip wheel
          pip install -r .github/scripts/requirements-rag.txt -c .github/scripts/constraints-rag.txt
          pip install pyyaml
          pip check

      # --- Your existing indexer (kept) ---
      - name: Build KB index (HF embeddings)
        env:
          KB_EMBED_MODEL: sentence-transformers/all-MiniLM-L6-v2
          KB_ROOT: kb
        run: |
          set -euo pipefail
          python .github/scripts/kb_index.py

      - name: Upload KB index artifact
        uses: actions/upload-artifact@v4
        with:
          name: kb-index
          path: ./.kb_index/**
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 14

      # --- Enhanced, section-aware chunking + metadata (externalized) ---
      - name: Enhanced chunking & metadata (Markdown-aware)
        env:
          KB_ROOT: kb
          OUT_DIR: .kb_index_enhanced
          KB_SOURCE_BASE_URL: ${{ env.KB_SOURCE_BASE_URL }}
        run: |
          set -euo pipefail
          python .github/scripts/kb-source-markdow-chunk.py \
            --kb-root "${KB_ROOT}" \
            --out-dir "${OUT_DIR}" \
            --source-base "${KB_SOURCE_BASE_URL}" \
            --max-chars 2400 \
            --overlap 300 \
            --ext .md .txt \
            --topics-map .github/scripts/hpcc4j-topics-to-kb-map.yml

      - name: Upload enhanced KB index artifact
        uses: actions/upload-artifact@v4
        with:
          name: kb-index-enhanced
          path: ./.kb_index_enhanced/**
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 14

      - name: Create unified KB bundle (curated + both indexes)
        run: |
          set -euo pipefail
          mkdir -p dist/kb-bundle
          cp -a kb dist/kb-bundle/kb
          [ -d .kb_index ] && cp -a .kb_index dist/kb-bundle/.kb_index || true
          cp -a .kb_index_enhanced dist/kb-bundle/.kb_index_enhanced
          tar -czf dist/kb-bundle.tar.gz -C dist kb-bundle

      - name: Upload unified KB bundle
        uses: actions/upload-artifact@v4
        with:
          name: kb-bundle
          path: |
            dist/kb-bundle/**
            dist/kb-bundle.tar.gz
          include-hidden-files: true
          retention-days: 14