name: Sync Jira → KB

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1-5"   # Weekdays at 06:00 UTC; adjust as needed
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  jira_to_kb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests python-slugify

      - name: Run Jira → KB export
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          # Use secret if set (and non-empty), else default to the HPCC Systems cloud Jira
          JIRA_BASE: ${{ secrets.JIRA_BASE != '' && secrets.JIRA_BASE || 'https://hpccsystems.atlassian.net' }}
          INPUT_JQL: ""
        run: |
          set -euo pipefail
          echo "Using JIRA_BASE=${JIRA_BASE}"

          python .github/scripts/jira_to_kb.py \
            --base "${JIRA_BASE}" \
            --auth "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --jql "${INPUT_JQL:-project=HPCC4J AND (statusCategory in ('To Do','In Progress') OR (statusCategory = Done AND updated >= -365d)) ORDER BY updated DESC}" \
            --limit 25 \
            --out kb/hpcc4j/jira \
            --debug

      - name: Commit KB output
        if: success() && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "== Git diagnostics (before) =="
          git rev-parse --abbrev-ref HEAD || true
          git status --porcelain || true
          git remote -v || true

          # Configure git author for CI commits
          git config user.name "kb-bot"
          git config user.email "kb-bot@users.noreply.github.com"

          # Stage only the KB directory
          git add kb/hpcc4j/jira

          echo "== Git diagnostics (after add) =="
          git status --porcelain || true

          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "No KB updates to commit."
            exit 0
          fi

          git commit -m "docs(kb): sync JIRA → KB (auto)"
          # Rebase to reduce push rejections on race
          git pull --rebase || true
          git push
