name: Analyze Issue with Copilot CLI

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Install GitHub Copilot CLI extension
        run: |
          gh extension install github/gh-copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get issue number
        id: issue_num
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch issue details
        id: issue
        run: |
          ISSUE_DATA=$(gh issue view ${{ steps.issue_num.outputs.number }} --json title,body,labels)
          echo "title=$(echo "$ISSUE_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.body // ""' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.labels[].name' > labels.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze issue with Copilot CLI
        id: analyze
        run: |
          # Create analysis prompt
          cat > analysis_prompt.txt <<'PROMPT'
          Analyze the following GitHub issue and determine if it contains sufficient information for a developer to understand and address it.

          Issue Title: ${{ steps.issue.outputs.title }}

          Issue Body:
          ${{ steps.issue.outputs.body }}

          Please evaluate:
          1. Is the issue description clear and specific?
          2. Are there steps to reproduce (if it's a bug)?
          3. Is the expected behavior described?
          4. Is the actual behavior described?
          5. Are there any error messages, logs, or stack traces included?
          6. Is version information provided (Java version, HPCC version, library version)?
          7. Is cluster connection information provided (endpoint, authentication details)?
          8. For HPCC4J specifically, which module does this relate to (wsclient, dfsclient, spark-hpcc, etc.)?

          Provide a summary with:
          - Overall assessment (SUFFICIENT or NEEDS_MORE_INFO)
          - List of missing information (if any)
          - Suggested questions to ask the reporter
          PROMPT

          # Use Copilot CLI to analyze
          ANALYSIS=$(gh copilot explain "$(cat analysis_prompt.txt)" 2>&1 || echo "Analysis failed")
          
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment analysis on issue
        run: |
          cat > comment.md <<'COMMENT'
          ## ðŸ¤– Copilot Issue Analysis

          ${{ steps.analyze.outputs.analysis }}

          ---
          *This analysis was automatically generated by GitHub Copilot CLI to help ensure issues contain sufficient information for investigation.*
          COMMENT

          gh issue comment ${{ steps.issue_num.outputs.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add label if more info needed
        if: contains(steps.analyze.outputs.analysis, 'NEEDS_MORE_INFO')
        run: |
          gh issue edit ${{ steps.issue_num.outputs.number }} --add-label "needs-more-info"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
