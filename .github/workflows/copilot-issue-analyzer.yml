name: Analyze Issue with Copilot CLI

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Setup GitHub CLI with Copilot access
        run: |
          # Use PAT with Copilot access
          if [ -n "${{ secrets.COPILOT_PAT }}" ]; then
            echo "${{ secrets.COPILOT_PAT }}" | gh auth login --with-token
            echo "‚úì Using Copilot PAT for authentication"
          else
            echo "‚ùå COPILOT_PAT not found - Copilot features will not be available"
            echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          fi

      - name: Verify Copilot access
        id: copilot_check
        run: |
          # Check if user has Copilot access via API
          COPILOT_STATUS=$(gh api /user/copilot_seat_details 2>&1 || echo "NO_ACCESS")
          if echo "$COPILOT_STATUS" | grep -q "seat"; then
            echo "has_copilot=true" >> $GITHUB_OUTPUT
            echo "‚úì GitHub Copilot access confirmed"
          else
            echo "has_copilot=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No GitHub Copilot access detected"
            echo "   Make sure the account associated with COPILOT_PAT has an active Copilot subscription"
          fi
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}

      - name: Get issue number
        id: issue_num
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch issue details
        id: issue
        run: |
          ISSUE_DATA=$(gh issue view ${{ steps.issue_num.outputs.number }} --json title,body,labels)
          echo "title=$(echo "$ISSUE_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.body // ""' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.labels[].name' > labels.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze issue with GitHub Copilot
        id: analyze
        run: |
          # Load the reusable prompt template
          PROMPT_TEMPLATE=$(cat .github/copilot-issue-analysis-prompt.md)
          
          # Replace placeholders with actual issue data
          TITLE="${{ steps.issue.outputs.title }}"
          BODY="${{ steps.issue.outputs.body }}"
          
          ANALYSIS_PROMPT="${PROMPT_TEMPLATE//\{ISSUE_TITLE\}/$TITLE}"
          ANALYSIS_PROMPT="${ANALYSIS_PROMPT//\{ISSUE_BODY\}/$BODY}"
          
          # Save the filled prompt
          echo "$ANALYSIS_PROMPT" > analysis_prompt.txt

          # Use GitHub Copilot API if access is available
          if [ "${{ steps.copilot_check.outputs.has_copilot }}" = "true" ]; then
            echo "ü§ñ Analyzing issue with GitHub Copilot..."
            
            # Create a conversation with Copilot using the Chat API
            API_RESPONSE=$(gh api \
              -X POST \
              /chat/completions \
              -H "Accept: application/vnd.github+json" \
              -f model="gpt-4" \
              -f messages[]='{"role":"system","content":"You are an expert at analyzing GitHub issues for the HPCC4J project."}' \
              -f messages[]='{"role":"user","content":"'"$(cat analysis_prompt.txt)"'"}' \
              2>&1)
            
            API_EXIT_CODE=$?
            
            # Check if API call was successful
            if [ $API_EXIT_CODE -eq 0 ] && echo "$API_RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
              ANALYSIS=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content')
              echo "‚úì Copilot analysis completed successfully"
            else
              # Log the error for debugging but don't include in output
              echo "‚ö†Ô∏è  Copilot API call failed (exit code: $API_EXIT_CODE)"
              if echo "$API_RESPONSE" | jq -e '.message' > /dev/null 2>&1; then
                ERROR_MSG=$(echo "$API_RESPONSE" | jq -r '.message')
                echo "   Error: $ERROR_MSG"
              fi
              echo "   Falling back to rule-based analysis..."
              ANALYSIS=$(python3 .github/scripts/analyze_issue.py "$TITLE" "$BODY")
            fi
          else
            echo "üìã Using rule-based analysis (Copilot not available)..."
            ANALYSIS=$(python3 .github/scripts/analyze_issue.py "$TITLE" "$BODY")
          fi
          
          # Ensure ANALYSIS is not empty
          if [ -z "$ANALYSIS" ]; then
            echo "‚ö†Ô∏è  Analysis output was empty, generating basic response..."
            ANALYSIS="## Analysis Error\n\nUnable to analyze issue automatically. Please review manually."
          fi
          
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}

      - name: Comment analysis on issue
        run: |
          # Only post comment if analysis was generated successfully
          if [ -n "${{ steps.analyze.outputs.analysis }}" ]; then
            cat > comment.md <<'COMMENT'
          ## ü§ñ GitHub Copilot Issue Analysis

          ${{ steps.analyze.outputs.analysis }}

          ---
          *This analysis was automatically generated using GitHub Copilot to help ensure issues contain sufficient information for investigation.*
          COMMENT

            gh issue comment ${{ steps.issue_num.outputs.number }} --body-file comment.md
            echo "‚úì Analysis comment posted successfully"
          else
            echo "‚ö†Ô∏è  No analysis output to post"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add label if more info needed
        if: contains(steps.analyze.outputs.analysis, 'NEEDS_MORE_INFO') && !contains(github.event.issue.labels.*.name, 'needs-more-info')
        run: |
          gh issue edit ${{ steps.issue_num.outputs.number }} --add-label "needs-more-info"
          echo "‚úì Added 'needs-more-info' label"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
