name: Analyze Issue with GitHub Copilot Chat

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Check Copilot access availability
        id: copilot_check
        env:
          COPILOT_PAT: ${{ secrets.COPILOT_PAT }}
        run: |
          # GitHub Copilot Chat API (api.githubcopilot.com) does NOT support Personal Access Tokens
          # Authentication requirements:
          #   - OAuth tokens from Copilot IDE extensions (not obtainable in workflows)
          #   - GitHub App installation tokens with Copilot permissions (complex setup)
          #   - VS Code extension tokens (session-based, not portable)
          # 
          # PATs (both classic and fine-grained) return: "bad request: Personal Access Tokens are not supported for this endpoint"
          # 
          # To integrate Copilot in the future:
          #   1. Create a GitHub App with Copilot permissions
          #   2. Install the app on this repository
          #   3. Generate installation tokens in the workflow
          #   4. Use those tokens for api.githubcopilot.com calls
          
          if [ -z "$COPILOT_PAT" ]; then
            echo "has_copilot=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  COPILOT_PAT not configured - will use rule-based analysis"
            exit 0
          fi
          
          # Install minimal tools for API check
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl jq > /dev/null 2>&1
          
          # Check what account the PAT belongs to
          echo "üîç Checking GitHub account for PAT..."
          USER_INFO=$(curl -s \
            -H "Authorization: Bearer $COPILOT_PAT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/user")
          
          USERNAME=$(echo "$USER_INFO" | jq -r '.login // "unknown"')
          USER_TYPE=$(echo "$USER_INFO" | jq -r '.type // "unknown"')
          echo "   Account: $USERNAME (type: $USER_TYPE)"
          
          # Check GitHub Copilot Chat API access
          echo "üîç Testing Copilot Chat API access..."
          HTTP_CODE=$(curl -s -o /tmp/copilot_check.json -w "%{http_code}" \
            -H "Authorization: Bearer $COPILOT_PAT" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -X POST \
            "https://api.githubcopilot.com/chat/completions" \
            -d '{"messages":[{"role":"user","content":"test"}],"model":"gpt-4o","stream":false,"max_tokens":5}')
          
          echo "   API Response Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "has_copilot=true" >> $GITHUB_OUTPUT
            echo "‚úì GitHub Copilot Chat API access confirmed for $USERNAME"
          else
            echo "has_copilot=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No GitHub Copilot Chat API access detected (HTTP $HTTP_CODE)"
            echo "   Response body:"
            cat /tmp/copilot_check.json 2>/dev/null | jq '.' || cat /tmp/copilot_check.json
            echo ""
            echo "   Will use rule-based analysis instead"
          fi

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          echo "‚úì GitHub CLI installed"

      - name: Setup GitHub CLI authentication
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          echo "‚úì Authenticated with GITHUB_TOKEN"

      - name: Get issue number
        id: issue_num
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_DATA=$(gh issue view ${{ steps.issue_num.outputs.number }} --json title,body,labels)
          echo "title=$(echo "$ISSUE_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.body // ""' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_DATA" | jq -r '.labels[].name // empty' > labels.txt 2>/dev/null || touch labels.txt

      - name: Analyze issue with GitHub Copilot Chat
        id: analyze
        env:
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          COPILOT_PAT: ${{ secrets.COPILOT_PAT }}
        run: |
          # Write issue data to temp files (using env vars to avoid bash interpolation issues)
          printf '%s' "$ISSUE_TITLE" > /tmp/issue_title.txt
          printf '%s' "$ISSUE_BODY" > /tmp/issue_body.txt

          # Use GitHub Copilot Chat API if access is available
          if [ "${{ steps.copilot_check.outputs.has_copilot }}" = "true" ]; then
            echo "ü§ñ Analyzing issue with GitHub Copilot Chat..."
            
            # Build the analysis prompt by combining template with issue data
            python3 .github/scripts/build_prompt.py \
              .github/copilot-issue-analysis-prompt.md \
              /tmp/issue_title.txt \
              /tmp/issue_body.txt > /tmp/analysis_prompt.txt
            
            # Call GitHub Copilot Chat API
            API_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $COPILOT_PAT" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "https://api.githubcopilot.com/chat/completions" \
              -d "{
                \"messages\": [
                  {\"role\": \"system\", \"content\": \"You are an expert at analyzing GitHub issues for the HPCC4J project.\"},
                  {\"role\": \"user\", \"content\": $(jq -Rs . < /tmp/analysis_prompt.txt)}
                ],
                \"model\": \"gpt-4o\",
                \"stream\": false
              }")
            
            # Check if API call was successful
            if echo "$API_RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
              ANALYSIS=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content')
              echo "‚úì Copilot Chat analysis completed successfully"
            else
              # Log the error for debugging
              echo "‚ö†Ô∏è  Copilot Chat API call failed"
              echo "Response: $API_RESPONSE"
              echo "   Falling back to rule-based analysis..."
              ANALYSIS=$(python3 .github/scripts/analyze_issue.py "$(cat /tmp/issue_title.txt)" "$(cat /tmp/issue_body.txt)" 2>&1)
              PYTHON_EXIT=$?
              if [ $PYTHON_EXIT -ne 0 ]; then
                echo "‚ö†Ô∏è  Python script failed with exit code: $PYTHON_EXIT"
                echo "Output: $ANALYSIS"
                ANALYSIS="## Analysis Error\n\nPython script execution failed. Please review manually."
              fi
            fi
          else
            echo "üìã Using rule-based analysis (Copilot not available)..."
            ANALYSIS=$(python3 .github/scripts/analyze_issue.py "$(cat /tmp/issue_title.txt)" "$(cat /tmp/issue_body.txt)" 2>&1)
            PYTHON_EXIT=$?
            if [ $PYTHON_EXIT -ne 0 ]; then
              echo "‚ö†Ô∏è  Python script failed with exit code: $PYTHON_EXIT"
              echo "Output: $ANALYSIS"
              ANALYSIS="## Analysis Error\n\nPython script execution failed. Please review manually."
            fi
          fi
          
          # Ensure ANALYSIS is not empty
          if [ -z "$ANALYSIS" ]; then
            echo "‚ö†Ô∏è  Analysis output was empty, generating basic response..."
            ANALYSIS="## Analysis Error\n\nUnable to analyze issue automatically. Please review manually."
          fi
          
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment analysis on issue
        env:
          ANALYSIS_OUTPUT: ${{ steps.analyze.outputs.analysis }}
          ISSUE_NUMBER: ${{ steps.issue_num.outputs.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Only post comment if analysis was generated successfully
          if [ -n "$ANALYSIS_OUTPUT" ]; then
            # Build comment header
            echo "## ü§ñ GitHub Copilot Issue Analysis" > comment.md
            echo "" >> comment.md
            # Append the analysis output
            echo "$ANALYSIS_OUTPUT" >> comment.md
            # Append footer
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "*This analysis was automatically generated using GitHub Copilot to help ensure issues contain sufficient information for investigation.*" >> comment.md

            # Use gh CLI if available, otherwise use curl
            if command -v gh &> /dev/null; then
              gh issue comment "$ISSUE_NUMBER" --body-file comment.md
            else
              curl -s -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments" \
                -d "{\"body\":$(jq -Rs . < comment.md)}" > /dev/null
            fi
            echo "‚úì Analysis comment posted successfully"
          else
            echo "‚ö†Ô∏è  No analysis output to post"
            exit 1
          fi

      - name: Add label if more info needed
        if: contains(steps.analyze.outputs.analysis, 'NEEDS_MORE_INFO') && !contains(github.event.issue.labels.*.name, 'needs-more-info')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue_num.outputs.number }} --add-label "needs-more-info"
          echo "‚úì Added 'needs-more-info' label"
